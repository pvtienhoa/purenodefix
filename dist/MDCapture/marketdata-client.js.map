{"version":3,"file":"marketdata-client.js","sourceRoot":"","sources":["../../MDCapture/marketdata-client.ts"],"names":[],"mappings":"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","sourcesContent":["import {\r\n    AsciiSession,\r\n    MsgView,\r\n    IJsFixConfig,\r\n    IJsFixLogger,\r\n    Dictionary,\r\n    MsgType,\r\n    SessionState,\r\n    FixSessionState,\r\n    MsgTransport,\r\n    Tags,\r\n    MsgTag\r\n} from 'jspurefix'\r\nimport * as cron from 'node-cron'\r\nimport {\r\n    IMarketDataRequest,\r\n    ISecurityListRequest,\r\n    IMassQuoteAcknowledgement,\r\n    MDUpdateType\r\n} from 'jspurefix/dist/types/FIX4.4/repo'\r\nimport { MarketDataFactory } from './marketdata-factory'\r\nimport { DBConnector } from './dbconnector';\r\nimport { IAppConfig, Common } from './common';\r\nimport { EventEmitter } from 'events';\r\nimport { LiveQuote } from './LiveQuote'\r\nimport { SubscriptionRequestType } from 'jspurefix/dist/types/FIX4.4/repo';\r\nimport * as moment from 'moment'\r\n\r\n\r\nexport class MarketDataClient extends AsciiSession {\r\n    private logger: IJsFixLogger\r\n    private fixLog: IJsFixLogger\r\n    private eventLog: IJsFixLogger\r\n    private liveQuotes: Dictionary<LiveQuote>\r\n    private dbConnector: DBConnector\r\n    private InsertAvgSpreadCronJob: cron.ScheduledTask\r\n    private dailyReconnectCronJob: cron.ScheduledTask\r\n    private msgCount: number\r\n    private isIdling: boolean\r\n    private idleDuration: number\r\n    private clientTickHandler: number\r\n    constructor(public readonly config: IJsFixConfig, private readonly appConfig: IAppConfig) {\r\n        super(config);\r\n        this.logReceivedMsgs = true;\r\n        this.fixLog = config.logFactory.plain(`${this.appConfig.FMsgType}-${this.appConfig.FUserName}-${this.appConfig.FSenderID}-${this.appConfig.FTargetID}.messages`, 5 * 1024 * 1024 * 1024);\r\n        this.eventLog = config.logFactory.plain(`${this.appConfig.FMsgType}-${this.appConfig.FUserName}-${this.appConfig.FSenderID}-${this.appConfig.FTargetID}.event`, 100 * 1024 * 1024, true);\r\n        this.logger = config.logFactory.logger(`${this.me}:MDClient`);\r\n        this.dbConnector = new DBConnector(this.appConfig, config.logFactory);\r\n        this.liveQuotes = new Dictionary<LiveQuote>();\r\n        this.msgCount = 0;\r\n        this.isIdling = false;\r\n        this.idleDuration = 0;\r\n        this.clientTickHandler = 0;\r\n        this.InsertAvgSpreadCronJob = cron.schedule(`*/${appConfig.AvgTerm} * * * *`, () => {\r\n            this.insertAvgSpreadsTick();\r\n        }, { scheduled: false });\r\n        this.dailyReconnectCronJob = cron.schedule(`0 2 * * *`, () => {\r\n            this.logger.info(`Daily disconnected`);\r\n            this.eventLog.info(`Daily disconnected`);\r\n            this.done();\r\n        }, {\r\n                scheduled: false,\r\n                timezone: \"Etc/UTC\"\r\n            });\r\n    }\r\n\r\n    // onApp Event Listener\r\n    protected onApplicationMsg(msgType: string, view: MsgView): void {\r\n        //this.logger.debug(`${view.toJson()}`)\r\n        switch (msgType) {\r\n            case MsgType.MassQuote:\r\n                var quoteID = view.getString(MsgTag.QuoteID);\r\n                if (quoteID) {\r\n                    let mqa: IMassQuoteAcknowledgement = MarketDataFactory.createMassQuoteAcknowledgement(quoteID);\r\n                    this.send(MsgType.MassQuoteAcknowledgement, mqa);\r\n                }\r\n            case MsgType.MarketDataSnapshotFullRefresh:\r\n            case MsgType.MarketDataIncrementalRefresh: {\r\n                this.msgCount++\r\n                let lqs = MarketDataFactory.parseLiveQuotes(msgType, view);\r\n                if (!lqs.length) throw new Error('no LiveQuotes from Parsed!');\r\n                lqs.forEach(e => {\r\n                    let lqToUpdate: LiveQuote\r\n                    if (e.symbol) lqToUpdate = this.liveQuotes.get(e.symbol)\r\n                    else lqToUpdate = this.liveQuotes.values().find(x => x.reqID === e.reqID)\r\n                    lqToUpdate.update(e);\r\n                    this.liveQuotes.addUpdate(lqToUpdate.symbol, lqToUpdate);\r\n                });\r\n                if (this.isIdling) this.isIdling = false;\r\n                break\r\n            }\r\n            case MsgType.SecurityList: {\r\n                this.logger.info('Security List received!')\r\n                //this.done();\r\n            }\r\n            default:\r\n                break\r\n        }\r\n    }\r\n\r\n    // onStop Event Listener\r\n    protected async onStopped() {\r\n        this.eventLog.info('Client stopped!');\r\n        this.logger.info('Stopped!');\r\n\r\n        // this.logger = null;\r\n        // this.fixLog = null;\r\n        // this.eventLog = null;\r\n\r\n        this.liveQuotes = null;\r\n\r\n        this.InsertAvgSpreadCronJob.destroy();\r\n        this.InsertAvgSpreadCronJob = null\r\n\r\n        this.InsertAvgSpreadCronJob.stop();\r\n        this.InsertAvgSpreadCronJob = null\r\n\r\n        this.dailyReconnectCronJob.stop();\r\n        this.dailyReconnectCronJob = null\r\n\r\n        this.msgCount = null\r\n        this.isIdling = null\r\n        this.idleDuration = null\r\n\r\n        clearInterval(this.clientTickHandler);\r\n        this.clientTickHandler = null;\r\n\r\n        await this.dbConnector.stop();\r\n    }\r\n\r\n    // use msgType for example to persist only trade capture messages to database\r\n    protected onDecoded(msgType: string, txt: string): void {\r\n        this.fixLog.info(txt)\r\n    }\r\n\r\n    // no delimiter substitution on transmit messages\r\n    protected onEncoded(msgType: string, txt: string): void {\r\n        this.fixLog.info(AsciiSession.asPiped(txt))\r\n    }\r\n\r\n    // onReady Event Listener\r\n    protected onReady(view: MsgView): void {\r\n        this.eventLog.info('Logged on!');\r\n        this.logger.info('ready')\r\n\r\n        // Send Test msg to Server\r\n        // this.logger.info('send test message...')\r\n        // const t: ITestRequest = MarketDataFactory.createTestRequest(this.appConfig.BrokerName)\r\n        // this.send(MsgType.TestRequest,t)\r\n\r\n        // Query Symbol list from server\r\n        // this.logger.info('query symbol list from server...')\r\n        // const slr: ISecurityListRequest = MarketDataFactory.createSecurityListRequest(this.appConfig.BrokerName,SecurityListRequestType.AllSecurities)\r\n        // this.send(MsgType.SecurityListRequest,slr)\r\n\r\n        try {\r\n            this.dbConnector.querySymbols().then(symbols => {\r\n                this.eventLog.info(`Symbol list accquired, count: ${symbols.length}`)\r\n                // Query data from Symbols table and create LiveQuote Dictionary\r\n                symbols.forEach(r => {\r\n                    let l = new LiveQuote(r.currencypairname, r.requestId, this.appConfig.FBrokerName, 0, 0, r.Digit);\r\n                    this.liveQuotes.addUpdate(r.currencypairname, l);\r\n\r\n                    // Create Martket Data Request with symbolist\r\n                    let mdr: IMarketDataRequest = MarketDataFactory.createMarketDataRequest(l.reqID, SubscriptionRequestType.SnapshotAndUpdates, l.symbol, MDUpdateType.IncrementalRefresh);\r\n\r\n                    // Send MD Request to server\r\n                    this.eventLog.info(`Sending MDRequest to host: ${this.appConfig.FHost}: ${this.appConfig.FPort}`);\r\n                    this.send(MsgType.MarketDataRequest, mdr)\r\n                });\r\n\r\n                //Start Cron-Jobs                \r\n                this.InsertAvgSpreadCronJob.start();\r\n                this.eventLog.info(`Cronjob for inserting AvgSpreads Started!`);\r\n                this.dailyReconnectCronJob.start();\r\n                this.eventLog.info(`Cronjob for daily Reconnect Started!`);\r\n                this.clientTickHandler = Common.startInterval(() => { this.clientTick() }, 200);\r\n                this.eventLog.info(`Interval job for updating LiveQuotes Started!`);\r\n            })\r\n        } catch (error) {\r\n            this.eventLog.error(error);\r\n            this.logger.error(error);\r\n        }\r\n\r\n        // let symbols = ['AUD/CAD','AUD/CHF','AUD/JPY','AUD/NZD','AUD/USD','CAD/CHF','CAD/JPY','CHF/JPY','EUR/AUD','EUR/CAD','EUR/CHF','EUR/GBP','EUR/JPY','EUR/USD']\r\n        // const mdr: IMarketDataRequest = MarketDataFactory.createMarketDataRequest(this.appConfig.BrokerName, SubscriptionRequestType.SnapshotAndUpdates, symbols)\r\n        // this.send(MsgType.MarketDataRequest, mdr)\r\n        // this.cronJob.start()\r\n        process.on('SIGINT', function () {\r\n            console.log(\"Caught interrupt signal\");\r\n            process.exit()\r\n        });\r\n    }\r\n\r\n    // onLogon Event Listener\r\n    protected onLogon(view: MsgView, user: string, password: string): boolean {\r\n        this.eventLog.info('Trying to Log on!');\r\n        this.logger.info(`peer logs in user ${user}`)\r\n        return true\r\n    }\r\n\r\n    protected updateLiveQuotesTick(): void {\r\n        if (this.liveQuotes && this.dbConnector && this.sessionState.state === SessionState.PeerLoggedOn) {\r\n            this.dbConnector.updateLiveQuotes(this.liveQuotes.values()).then((res) => {\r\n                if (res) this.logger.info(`LiveQuotes Updated`);\r\n            }).catch((err) => {\r\n                throw err;\r\n            });\r\n        }\r\n    }\r\n\r\n    protected insertAvgSpreadsTick(): void {\r\n        if (this.liveQuotes && this.dbConnector && this.sessionState.state === SessionState.PeerLoggedOn) {\r\n            this.dbConnector.insertAvgSpreads(this.liveQuotes.values()).then((res) => {\r\n                if (res) {\r\n                    this.eventLog.info(`AVGSpreads Inserted`);\r\n                    this.logger.info(`AVGSpreads Inserted`);\r\n                }\r\n            }).catch((err) => {\r\n                throw err;\r\n            });\r\n        }\r\n    }\r\n\r\n    protected clientTick() {\r\n        if (this.isIdling) this.idleDuration += 200;\r\n        else this.idleDuration = 0;\r\n        this.isIdling = true;\r\n        if (this.idleDuration >= this.appConfig.FNoMsgResetTimeout * 1 * 1000) {\r\n            this.eventLog.info(`Client has been idle for ${this.appConfig.FNoMsgResetTimeout} minutes, Reconnecting`);\r\n            this.logger.info(`Client has been idle for ${this.appConfig.FNoMsgResetTimeout} minutes, Reconnecting`);\r\n            this.done();\r\n        }\r\n        this.updateLiveQuotesTick();\r\n        this.liveQuotes.values().forEach(lq => {\r\n            lq.lqFlag = false;\r\n            this.liveQuotes.addUpdate(lq.symbol, lq);\r\n        });\r\n    }\r\n}"]}