{"version":3,"file":"dbconnector.js","sourceRoot":"","sources":["../../MDCapture/dbconnector.ts"],"names":[],"mappings":"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","sourcesContent":["import * as mariadb from 'mariadb'\r\nimport { JsFixWinstonLogFactory, WinstonLogger, IJsFixConfig, IJsFixLogger, SessionMsgFactory, makeConfig, JsFixLoggerFactory, Dictionary } from 'jspurefix'\r\nimport { IAppConfig, Common } from './common'\r\nimport { ILiveQuotes } from './marketdata-factory'\r\nimport { ILiveQuote, IAverageSpread } from './LiveQuote';\r\nimport { promises } from 'fs';\r\n\r\nexport class DBConnector {\r\n    private appConfig: IAppConfig\r\n    private pool: any\r\n    private logger: IJsFixLogger\r\n\r\n    constructor(opt: IAppConfig, logFactory: JsFixLoggerFactory) {\r\n        this.logger = logFactory.logger('dbconnector')\r\n        this.appConfig = opt;\r\n        debugger\r\n        if (this.appConfig.DBHost) {\r\n            this.pool = mariadb.createPool({\r\n                host: this.appConfig.DBHost,\r\n                user: this.appConfig.DBUserName,\r\n                password: this.appConfig.DBPassword,\r\n                database: this.appConfig.DBDatabase,\r\n                connectionLimit: 20,\r\n                idleTimeout: 30\r\n            });\r\n        } else {\r\n            this.pool = mariadb.createPool({\r\n                socketPath: this.appConfig.DBSocketPath,\r\n                user: this.appConfig.DBUserName,\r\n                password: this.appConfig.DBPassword,\r\n                database: this.appConfig.DBDatabase,\r\n                connectionLimit: 20\r\n            });\r\n        }\r\n\r\n    }\r\n    public async querySymbols(): Promise<any[]> {\r\n        return new Promise<any[]>((accept, reject) => {\r\n            this.logger.info('idle connections: ' + this.pool.idleConnections());\r\n            this.pool.query(`Select * From ${this.appConfig.TblSymbols} Where LiveQuotes = ?`, [1])\r\n                .then((rows: any[]) => {\r\n                    accept(rows)\r\n                })\r\n                .catch((err: Error) => {\r\n                    this.logger.error(new Error('error querying Symbols - ' + err.message))\r\n                    reject(err);\r\n                });\r\n\r\n        });\r\n    }\r\n\r\n    /**\r\n     * queryLastAvgSpread\r\n     */\r\n    // public async queryLastAvgSpreads(): Promise<Dictionary<AvgSpread>> {\r\n    //     const conn = await this.pool.getConnection();\r\n    //     const rows: any[] = await conn.query(`WITH ranked_rows AS (SELECT r.*, ROW_NUMBER() OVER (PARTITION BY Symbol ORDER BY ID DESC) AS rn FROM AverageSpreads AS r) SELECT * FROM ranked_rows WHERE rn = 1`);\r\n    //     conn.end();\r\n    //     if (rows) {\r\n    //         var ret = new Dictionary<AvgSpread>();\r\n    //         rows.forEach(row => {\r\n    //             let a = new AvgSpread(row.BrokerName, row.Symbol)\r\n    //             a.lastAvg = row.AvgSpread\r\n    //             ret.addUpdate(a.symbol, a)\r\n    //         })\r\n    //         return ret;\r\n    //     }\r\n    //     else {\r\n    //         this.logger.error(new Error('Cannot get Rows!'));\r\n    //         return undefined;\r\n    //     };\r\n    // }\r\n\r\n    public async updateLiveQuotes(lqs: ILiveQuote[]) {\r\n        return new Promise<boolean>((accept, reject) => {\r\n            if (this.pool.idleConnections() <= 1) {\r\n                this.logger.warning('No idle Connection... Skipped writing to DB!')\r\n                accept(false);\r\n            }\r\n            var lqParams: any[] = [];\r\n            lqs.forEach(lq => {\r\n                if (lq.lqFlag) {\r\n                    lqParams.push([Common.getTimeStamp(this.appConfig.TimeZone, lq.timeStamp), this.appConfig.FBrokerName, lq.bid, lq.ask, Common.roundToFixed(lq.spread, 1), lq.symbol])\r\n                }\r\n            })\r\n            if (lqParams.length > 0) {\r\n                this.pool.batch(`\r\n                UPDATE ${this.appConfig.TblLiveQuotes} SET \r\n                    TimeStamp = ?, \r\n                    BrokerName = ?, \r\n                    Bid = ?, \r\n                    Ask = ?, \r\n                    Spread = ?  \r\n                WHERE Symbol = ?;`, lqParams).then(\r\n                    accept(true)\r\n                ).catch((err: Error) => {\r\n                    this.logger.error(new Error('error updating LQ into DB - ' + err.message))\r\n                    reject(err);\r\n                });\r\n            }\r\n            else accept(false);\r\n        })\r\n    }\r\n    async insertAvgSpreads(avgSpreads: IAverageSpread[]) {\r\n        return new Promise<boolean>((accept, reject) => {\r\n            if (!this.pool.idleConnections()) {\r\n                this.logger.warning('No idle Connection... Skipped writing to DB!')\r\n                accept(false);\r\n            }\r\n            var aqParams: any[] = [];\r\n            avgSpreads.forEach(avg => {\r\n                if (avg.avgFlag) {\r\n                    avg.avgCalc();\r\n                    aqParams.push([Common.getTimeStamp(this.appConfig.TimeZone), this.appConfig.AvgTerm * 60, this.appConfig.FBrokerName, avg.symbol, avg.avgSpread]);\r\n                    //avg.reset();\r\n                }\r\n            });\r\n            if (aqParams.length > 0) {\r\n                this.pool.batch(`INSERT INTO ${this.appConfig.TblAverageSpreads}(TimeStamp, Duration, BrokerName, Symbol, AvgSpread) VALUES (?, ?, ?, ?, ?)`, aqParams).then(\r\n                    accept(true)\r\n                ).catch((err: Error) => {\r\n                    this.logger.error(new Error('error updating AvgSpread into DB - ' + err.message))\r\n                    reject(err);\r\n                });\r\n            }\r\n            else accept(false);\r\n        })\r\n    }\r\n    public stop(): boolean {\r\n        this.logger = null;\r\n        this.appConfig = null;\r\n        this.pool.end()\r\n            .then()\r\n            .catch((err: Error) => {\r\n                this.logger.error(new Error('error destroying Connection Pool - ' + err.message));\r\n                return false;\r\n            });\r\n        return true;\r\n    }\r\n}"]}