"use strict";var __awaiter=this&&this.__awaiter||function(o,e,i,t){return new(i||(i=Promise))(function(n,r){function a(o){try{p(t.next(o))}catch(o){r(o)}}function s(o){try{p(t.throw(o))}catch(o){r(o)}}function p(o){o.done?n(o.value):new i(function(e){e(o.value)}).then(a,s)}p((t=t.apply(o,e||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const mariadb=require("mariadb"),common_1=require("./common");class DBConnector{constructor(o,e){this.logger=e.logger("dbconnector"),this.appConfig=o,this.appConfig.DBHost?this.pool=mariadb.createPool({host:this.appConfig.DBHost,user:this.appConfig.DBUserName,password:this.appConfig.DBPassword,database:this.appConfig.DBName,connectionLimit:this.appConfig.DBLimitConn,idleTimeout:30}):this.pool=mariadb.createPool({socketPath:this.appConfig.DBSocketPath,user:this.appConfig.DBUserName,password:this.appConfig.DBPassword,database:this.appConfig.DBName,connectionLimit:20})}querySymbols(){return __awaiter(this,void 0,void 0,function*(){return new Promise((o,e)=>{this.logger.info("idle connections: "+this.pool.idleConnections()),this.pool.query(`Select * From ${this.appConfig.TblSymbols} Where LiveQuotes = ?`,[1]).then(e=>{o(e)}).catch(o=>{this.logger.error(new Error("error querying Symbols - "+o.message)),e(o)})})})}updateLiveQuotes(o){return __awaiter(this,void 0,void 0,function*(){return new Promise((e,i)=>{this.pool.idleConnections()<=1&&(this.logger.warning("No idle Connection... Skipped writing to DB!"),e(!1));var t=[];o.forEach(o=>{o.lqFlag&&t.push([common_1.Common.getTimeStamp(this.appConfig.TimeZone,o.timeStamp),o.bid,o.ask,common_1.Common.roundToFixed(o.spread,1),o.symbol,this.appConfig.Broker])}),t.length>0?this.pool.batch(`\n                UPDATE ${this.appConfig.TblLiveQuotes} SET \n                    TimeStamp = ?,\n                    Bid = ?, \n                    Ask = ?, \n                    Spread = ?  \n                WHERE Symbol = ? AND BrokerName = ?;`,t).then(e(!0)).catch(o=>{this.logger.error(new Error("error updating LQ into DB - "+o.message)),i(o)}):e(!1)})})}insertAvgSpreads(o){return __awaiter(this,void 0,void 0,function*(){return new Promise((e,i)=>{this.pool.idleConnections()||(this.logger.warning("No idle Connection... Skipped writing to DB!"),e(!1));var t=[];o.forEach(o=>{o.avgFlag&&(o.avgCalc(),t.push([common_1.Common.getTimeStamp(this.appConfig.TimeZone),60*this.appConfig.AvgTerm,this.appConfig.Broker,o.symbol,o.avgSpread]))}),t.length>0?this.pool.batch(`INSERT INTO ${this.appConfig.TblAverageSpreads}(TimeStamp, Duration, BrokerName, Symbol, AvgSpread) VALUES (?, ?, ?, ?, ?)`,t).then(e(!0)).catch(o=>{this.logger.error(new Error("error updating AvgSpread into DB - "+o.message)),i(o)}):e(!1)})})}stop(){return this.logger=null,this.appConfig=null,this.pool.end().then().catch(o=>(this.logger.error(new Error("error destroying Connection Pool - "+o.message)),!1)),!0}}exports.DBConnector=DBConnector;